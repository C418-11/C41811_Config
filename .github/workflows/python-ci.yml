name: üêç Python CI

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'
      - 'MANIFEST.in'
      - 'pyproject.toml'
      - '.github/workflows/python-ci.yml'
  pull_request:
    paths:
      - '**.py'
      - 'MANIFEST.in'
      - 'pyproject.toml'
      - '.github/workflows/python-ci.yml'

jobs:
  ruff:
    name: ‚ö° Ruff
    runs-on: ubuntu-latest

    permissions:
      contents: read  # for setup-python

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . --group ruff

      - name: Run ruff
        run: |
          ruff check --no-fix
          ruff format --check
  pytest:
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
        python-version: [ '3.12', '3.13', '3.14', '3.14t' ]
        exclude:
          # ÊéíÈô§ Windows + Python 3.14t ÁöÑÁªÑÂêàÔºåÂõ†‰∏∫pywin32‰∏çÊîØÊåÅ
          - os: windows-latest
            python-version: '3.14t'
      fail-fast: false
    name: üß™ PyTest py${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: ruff

    environment:
      name: codecov
    permissions:
      contents: read  # for setup-python

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . --group dev --group test

      - name: Run tests
        run: |
          pytest --cov=src --junitxml=junit.xml -o junit_family=legacy

      - name: Upload coverage to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  mypy:
    name: üîé MyPy
    runs-on: ubuntu-latest
    needs: ruff

    permissions:
      contents: read  # for setup-python

    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . --group mypy

      - name: Cache mypy
        uses: actions/cache@v5
        with:
          path: .mypy_cache
          key: mypy-cache-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            mypy-cache-

      - name: Run type checks
        run: |
          mypy tests
          pip uninstall -y C41811.Config
          mypy src
